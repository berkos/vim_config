class MlbRankingJsonGenerator
  def initialize(params = {})

    players_ids = [ ]
    rankers_ids = [ ]
    @position = params[:category] || 'OF'
    @rank_for = params[:ranking_category] || 'draftkings'
    @date = Date.today
    @sort = params[:sort] || 'ASC'
    @page = params[:page]
    @per_page = params[:per_page]
    @salaries = PlayerSalary.for_sport_and_gamedate(4, Time.zone.now.to_date).includes(:site).where(sites: {name: @rank_for})
    mlb_rankings = MlbRanking.where(gameDate: @date, rank_for: @rank_for)

    mlb_rankings.each do |mlb_ranking|
      players_ids = players_ids + mlb_ranking.players(@position)
      rankers_ids <<  mlb_ranking.nickname_id
    end

    @mlb_rankings = mlb_rankings

    players_ids.uniq!
    rankers_ids.uniq!

    @rankers = User.find(rankers_ids)
    @players = Kaminari.paginate_array(Player.find(players_ids, order: "last_name #{@sort}")).page(@page).per(@per_page)

  end

  def create_json
    hash2 = Hash.new
    hash3 = Hash.new

    hash3['experts'] = []

    @players.each do |player|
      hash2[player.name] = Hash.new
      hash2[player.name]['player'] = player.name
      player_salary = @salaries.where(player_id: player.id).first
      hash2[player.name]['position'] = @position
      hash2[player.name]['salary'] = player_salary.try(:salary).to_i || 0
      hash2[player.name]['game'] = player_salary.try(:opponent) || ''
      hash2[player.name]['id'] = player.id

    end

    @mlb_rankings.each_with_index do |mlb_ranking, y|
      Player.find(mlb_ranking.players(@position)).sort_by {|p| mlb_ranking.players(@position).index(p.id) }.each_with_index do |player, i|
        if @players.include? player
        
          hash4 = Hash.new
          uniqueRankingId = mlb_ranking.nickname.id + y + i + Random.rand(1000)

          hash4["expert#{1+y}"] = Hash.new

          hash4["expert#{1+y}"]['id'] = uniqueRankingId
          hash4["expert#{1+y}"]['name'] = mlb_ranking.nickname.name
          hash4["expert#{1+y}"]['rank'] = 1+i
          
          hash2[player.name]["expert#{1+y}_id"] = uniqueRankingId
          hash3['experts'] << hash4["expert#{1+y}"]
        end
      end
    end


    hash2.each do |hash_record|
      hash_record[1].keys.sort
    end

    hash3['mlb_ranked_players'] = hash2.to_a.map{ |row| row[1] }
    hash3.to_json

  end
end
